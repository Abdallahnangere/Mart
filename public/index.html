<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SAUKI MART</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://checkout.flutterwave.com/v3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* STRICT 100% HEIGHT LAYOUT */
        html, body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000; 
            height: 100dvh; /* Dynamic Height */
            width: 100vw;
            overflow: hidden; /* No Body Scroll */
            margin: 0; padding: 0;
            display: flex; justify-content: center;
        }
        
        /* APP FRAME (Mobile Simulation) */
        #app-frame { 
            background-color: #F5F5F7; 
            width: 100%; 
            max-width: 430px; /* iPhone Max Width */
            height: 100%; 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        
        /* HEADER (Fixed at top of frame) */
        .glass-header { 
            position: absolute; top: 0; left: 0; right: 0; height: 85px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); 
            z-index: 50; padding: 45px 20px 10px 20px; 
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center; 
        }

        /* SCROLLABLE CONTENT AREAS */
        .content-area { 
            position: absolute; inset: 0; top: 85px; /* Starts below header */
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding: 20px;
            padding-bottom: 40px; 
            display: none; 
            background: #F5F5F7;
        }
        .content-area.active { display: block; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* COMPONENTS */
        .ios-card { background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition: 0.1s; }
        .ios-card:active { transform: scale(0.97); }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="app-frame">
        
        <!-- HEADER -->
        <header class="glass-header">
            <div class="flex items-center gap-3">
                <img src="logo.png" onerror="this.src='https://placehold.co/40?text=S'" class="w-10 h-10 rounded-xl border border-gray-100 shadow-sm">
                <div>
                    <h1 class="text-sm font-bold leading-none text-gray-900 tracking-tight">SAUKI MART</h1>
                    <span class="text-[10px] text-green-600 font-bold flex items-center gap-1 mt-0.5">
                        <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div> Certified
                    </span>
                </div>
            </div>
            <!-- Admin Link -->
            <a href="admin.html" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center opacity-50">
                <i data-lucide="shield" class="w-3 h-3 text-gray-400"></i>
            </a>
        </header>

        <!-- VIEW 1: HOME -->
        <div id="view-home" class="content-area active">
            
            <!-- Hero -->
            <div class="bg-[#111] rounded-3xl p-6 text-white mb-4 relative overflow-hidden shadow-xl shadow-gray-200">
                <div class="relative z-10">
                    <span class="border border-white/20 px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider backdrop-blur-md">Official Partner</span>
                    <h2 class="text-xl font-bold mt-3 mb-1">Premium Data.<br>Instant Delivery.</h2>
                    <p class="text-gray-400 text-xs mb-4">MTN, Glo & Airtel Authorized.</p>
                    <button onclick="nav('data')" class="bg-white text-black px-6 py-2.5 rounded-full text-xs font-bold active:opacity-80 transition">Buy Bundle</button>
                </div>
                <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-blue-600 rounded-full blur-3xl opacity-30"></div>
            </div>

            <!-- Main Menu -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div onclick="nav('devices')" class="ios-card p-4 h-36 flex flex-col justify-between cursor-pointer">
                    <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center"><i data-lucide="router" class="text-blue-600 w-5 h-5"></i></div>
                    <div><span class="font-bold text-sm block">Shop Devices</span><span class="text-[10px] text-gray-400">Routers & SIMs</span></div>
                </div>
                <div onclick="nav('agent')" class="ios-card p-4 h-36 flex flex-col justify-between cursor-pointer">
                    <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center"><i data-lucide="users" class="text-green-600 w-5 h-5"></i></div>
                    <div><span class="font-bold text-sm block">Agent Portal</span><span class="text-[10px] text-gray-400">Reseller Wallet</span></div>
                </div>
            </div>

            <!-- Track -->
            <div class="ios-card p-4 mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="bg-purple-50 w-8 h-8 rounded-full flex items-center justify-center"><i data-lucide="search" class="text-purple-600 w-4 h-4"></i></div>
                    <h3 class="font-bold text-xs">Track Transaction</h3>
                </div>
                <div class="flex gap-2">
                    <input id="track-input" type="tel" placeholder="Phone Number" class="flex-1 bg-gray-50 rounded-xl px-4 py-2.5 text-xs font-bold outline-none">
                    <button onclick="trackOrder()" class="bg-black text-white px-4 rounded-xl text-xs font-bold">Check</button>
                </div>
                <div id="track-results" class="mt-2 space-y-1"></div>
            </div>

            <!-- CONTACTS -->
            <div class="text-center pb-8 border-t border-gray-200 pt-6">
                <h4 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">Support</h4>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <a href="https://wa.me/2348164135836" class="ios-card p-3 flex items-center gap-3 border border-green-100">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"><i data-lucide="message-circle" class="w-4 h-4 text-green-600"></i></div>
                        <div class="text-left"><span class="block text-[10px] text-gray-400">WhatsApp</span><span class="font-bold text-xs">0816...</span></div>
                    </a>
                    <a href="https://wa.me/2348061934056" class="ios-card p-3 flex items-center gap-3 border border-green-100">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"><i data-lucide="message-circle" class="w-4 h-4 text-green-600"></i></div>
                        <div class="text-left"><span class="block text-[10px] text-gray-400">WhatsApp</span><span class="font-bold text-xs">0806...</span></div>
                    </a>
                    <a href="mailto:saukidatalinks@gmail.com" class="ios-card p-3 flex items-center gap-3 col-span-2">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center"><i data-lucide="mail" class="w-4 h-4 text-gray-600"></i></div>
                        <div class="text-left"><span class="block text-[10px] text-gray-400">Email Support</span><span class="font-bold text-xs">saukidatalinks@gmail.com</span></div>
                    </a>
                </div>
                <div class="flex justify-center items-center gap-5 grayscale opacity-60">
                    <img src="coat.png" class="h-8 object-contain" onerror="this.style.display='none'">
                    <div class="h-6 w-px bg-gray-300"></div>
                    <img src="smedan.png" class="h-8 object-contain" onerror="this.style.display='none'">
                </div>
            </div>
        </div>

        <!-- VIEW 2: BUY DATA -->
        <div id="view-data" class="content-area">
            <button onclick="nav('home')" class="mb-4 text-xs font-bold text-gray-500 flex items-center gap-1"><i data-lucide="arrow-left" class="w-3 h-3"></i> Home</button>
            <h2 class="text-2xl font-bold mb-6">Buy Bundle</h2>
            <div class="flex gap-2 mb-6">
                <button onclick="loadPlans(1)" id="net-1" class="flex-1 py-3 rounded-xl border border-gray-200 font-bold text-xs">MTN</button>
                <button onclick="loadPlans(2)" id="net-2" class="flex-1 py-3 rounded-xl border border-gray-200 font-bold text-xs">Glo</button>
                <button onclick="loadPlans(3)" id="net-3" class="flex-1 py-3 rounded-xl border border-gray-200 font-bold text-xs">Airtel</button>
            </div>
            <div id="plans-list" class="space-y-3 pb-20"></div>
        </div>

        <!-- VIEW 3: DEVICES -->
        <div id="view-devices" class="content-area">
            <button onclick="nav('home')" class="mb-4 text-xs font-bold text-gray-500 flex items-center gap-1"><i data-lucide="arrow-left" class="w-3 h-3"></i> Home</button>
            <h2 class="text-2xl font-bold mb-6">Premium Devices</h2>
            <div id="products-list" class="grid grid-cols-2 gap-4 pb-20"></div>
        </div>

        <!-- MODAL: PAY -->
        <div id="modal-pay" class="fixed inset-0 z-[60] bg-white/95 backdrop-blur-xl hidden flex flex-col items-center justify-center p-8">
            <div class="w-full max-w-xs text-center">
                <h2 class="font-bold text-xl mb-8">Processing Order</h2>
                
                <div class="flex items-center gap-4 mb-6 transition-all" id="stg-1">
                    <div id="ldr-1" class="w-8 h-8 rounded-full border-2 border-gray-200 border-t-black animate-spin"></div>
                    <div class="text-left"><p class="font-bold text-sm">Payment</p><p class="text-[10px] text-gray-400">Verifying...</p></div>
                </div>
                
                <div class="flex items-center gap-4 mb-8 opacity-30 transition-all" id="stg-2">
                    <div id="ldr-2" class="w-8 h-8 rounded-full border-2 border-gray-200"></div>
                    <div class="text-left"><p class="font-bold text-sm">Delivery</p><p class="text-[10px] text-gray-400">Sending Data...</p></div>
                </div>

                <div id="pay-success" class="hidden animate-bounce-in">
                    <div class="bg-green-100 text-green-700 p-3 rounded-xl font-bold text-xs mb-4">Delivery Successful!</div>
                    <button onclick="downloadReceipt()" class="bg-black text-white w-full py-3 rounded-xl font-bold text-sm mb-3">Download Receipt</button>
                    <button onclick="document.getElementById('modal-pay').classList.add('hidden')" class="text-xs text-gray-400">Close</button>
                </div>
            </div>
        </div>

        <!-- RECEIPT -->
        <div id="receipt-el" class="fixed top-0 left-[-2000px] w-[350px] bg-white p-8 border border-gray-100">
            <div class="text-center border-b border-gray-100 pb-4 mb-4">
                <h1 class="font-bold text-lg tracking-widest uppercase">SAUKI MART</h1>
                <p class="text-[10px] text-gray-400">Certified Data Vendor</p>
            </div>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between"><span>Date</span><span class="font-bold" id="rec-date"></span></div>
                <div class="flex justify-between"><span>Ref</span><span class="font-mono" id="rec-ref"></span></div>
                <div class="flex justify-between"><span>Item</span><span class="font-bold" id="rec-item"></span></div>
                <div class="flex justify-between"><span>Amount</span><span class="font-bold" id="rec-amt"></span></div>
            </div>
            <div class="mt-6 text-center">
                <p class="text-[9px] text-gray-400">saukidatalinks@gmail.com • 08164135836</p>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        let currentNet = 1;

        function nav(id) {
            document.querySelectorAll('.content-area').forEach(e => e.classList.remove('active'));
            document.getElementById(`view-${id}`).classList.add('active');
            if(id === 'data') loadPlans(1);
            if(id === 'devices') loadProducts();
        }

        async function loadPlans(netId) {
            currentNet = netId;
            const list = document.getElementById('plans-list');
            list.innerHTML = "Loading...";
            try {
                const res = await fetch(`${API}/plans`);
                const plans = await res.json();
                list.innerHTML = "";
                plans.filter(p => p.network === netId).forEach(p => {
                    list.innerHTML += `
                        <div onclick="buyItem('data', ${p.price}, ${p.planId}, '${p.name}')" class="ios-card p-4 flex justify-between items-center cursor-pointer">
                            <div><span class="font-bold text-sm block">${p.name}</span><span class="text-[10px] text-gray-400">30 Days</span></div>
                            <span class="bg-black text-white text-xs font-bold px-3 py-1.5 rounded-lg">₦${p.price}</span>
                        </div>`;
                });
            } catch(e) { list.innerHTML = "Error loading plans."; }
        }

        async function loadProducts() {
            const list = document.getElementById('products-list');
            const res = await fetch(`${API}/products`);
            const prods = await res.json();
            list.innerHTML = "";
            prods.forEach(p => {
                list.innerHTML += `
                    <div onclick="buyItem('device', ${p.price}, ${p.id}, '${p.name}')" class="ios-card p-4">
                        <div class="h-24 bg-gray-50 rounded-lg mb-2 flex items-center justify-center text-xs text-gray-400 font-bold">${p.name}</div>
                        <h3 class="font-bold text-sm">${p.name}</h3>
                        <p class="text-xs font-bold mt-1">₦${p.price}</p>
                    </div>`;
            });
        }

        async function buyItem(type, amount, id, name) {
            const phone = prompt("Enter Beneficiary Phone:");
            if(!phone) return;
            
            try {
                // 1. Init with Error Handling
                const res = await fetch(`${API}/buy/init`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ amount, phone, type, planId: type==='data'?id:null, productId: type==='device'?id:null, productName: name, networkId: currentNet })
                });
                
                const tx = await res.json();
                
                if (!res.ok) {
                    throw new Error(tx.error || "Initialization failed");
                }

                // 2. FLW
                FlutterwaveCheckout({
                    public_key: "FLWPUBK_TEST-SANDBOXDEMO", tx_ref: tx.reference, amount, currency: "NGN",
                    payment_options: "card,banktransfer", customer: { email: "user@sauki.com", phone_number: phone, name: "Sauki User" },
                    customizations: { title: "Sauki Mart", description: name, logo: "https://sauki-mart.vercel.app/logo.png" },
                    callback: function(data) { verify(tx.reference, amount, name); }, onclose: function() {}
                });
            } catch (e) {
                alert("Order Error: " + e.message);
                console.error(e);
            }
        }

        async function verify(ref, amt, item) {
            const modal = document.getElementById('modal-pay');
            modal.classList.remove('hidden');
            document.getElementById('rec-date').innerText = new Date().toLocaleDateString();
            document.getElementById('rec-ref').innerText = ref;
            document.getElementById('rec-item').innerText = item;
            document.getElementById('rec-amt').innerText = "₦" + amt;

            setTimeout(async () => {
                document.getElementById('stg-1').classList.add('opacity-30');
                document.getElementById('ldr-1').classList.remove('animate-spin'); document.getElementById('ldr-1').classList.add('bg-green-500', 'border-none');
                
                document.getElementById('stg-2').classList.remove('opacity-30'); document.getElementById('ldr-2').classList.add('animate-spin', 'border-t-black');

                const res = await fetch(`${API}/buy/verify`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reference: ref }) });
                const data = await res.json();

                document.getElementById('ldr-2').classList.remove('animate-spin');
                if(data.delivery) {
                    document.getElementById('ldr-2').classList.add('bg-green-500', 'border-none');
                    document.getElementById('pay-success').classList.remove('hidden');
                } else { alert("Delivery Pending. Check Admin."); modal.classList.add('hidden'); }
            }, 1000);
        }

        async function trackOrder() {
            const p = document.getElementById('track-input').value;
            const res = await fetch(`${API}/track/${p}`);
            const txs = await res.json();
            const div = document.getElementById('track-results');
            div.innerHTML = "";
            txs.forEach(t => {
                div.innerHTML += `<div class="bg-white p-2 rounded-lg text-[10px] mb-1 border border-gray-100 flex justify-between">
                    <span>${t.status.toUpperCase()}</span><span>₦${t.amount}</span>
                </div>`;
            });
        }

        function downloadReceipt() {
             html2canvas(document.getElementById('receipt-el')).then(c => {
                 const a = document.createElement('a'); a.download="Sauki-Rec.png"; a.href=c.toDataURL(); a.click();
             });
        }

        lucide.createIcons();
    </script>
</body>
    </html>
