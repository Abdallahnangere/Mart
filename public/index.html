<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAUKI MART | Premium Data & Devices</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Receipt Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Apple-style Smoothness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fafafa; /* neutral-50 */
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* Prevent body scroll */
            touch-action: pan-x pan-y;
        }
        
        /* Hide Scrollbar but allow scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Slide Transitions */
        .view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: #fafafa;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s ease;
            opacity: 0;
            pointer-events: none;
            transform: translateX(100%);
            z-index: 10;
        }

        .view.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
            z-index: 20;
        }

        .view.exit-left {
            transform: translateX(-30%);
            opacity: 0;
            z-index: 10;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* Interactions */
        .door-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .door-card:active {
            transform: scale(0.96);
        }
        
        .btn-press:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="text-gray-800 antialiased select-none">

    <!-- APP CONTAINER -->
    <div id="app" class="relative w-full h-screen overflow-hidden max-w-md mx-auto bg-white shadow-2xl sm:rounded-3xl sm:h-[90vh] sm:mt-[5vh] sm:border sm:border-gray-100">

        <!-- NOTIFICATION TOAST -->
        <div id="toast" class="absolute top-6 left-1/2 transform -translate-x-1/2 bg-gray-900/95 backdrop-blur text-white px-6 py-3 rounded-full shadow-xl z-[60] text-sm font-medium transition-all duration-300 opacity-0 translate-y-[-40px] pointer-events-none flex items-center gap-2 w-max max-w-[90%]">
            <i data-lucide="info" class="w-4 h-4 text-blue-400"></i>
            <span id="toast-msg">Notification</span>
        </div>

        <!-- LOADING OVERLAY -->
        <div id="loader" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-[70] hidden flex-col items-center justify-center transition-opacity duration-300">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mb-4"></div>
            <p class="text-sm font-semibold text-gray-600 tracking-wide animate-pulse">Processing Securely...</p>
        </div>

        <!-- ======================= 1. HOME VIEW ======================= -->
        <div id="view-home" class="view active no-scrollbar p-6 flex flex-col h-full bg-gray-50/50">
            <!-- Header -->
            <div class="mt-6 mb-8 flex flex-col items-center text-center">
                <!-- Logo -->
                <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mb-5 shadow-sm border border-gray-100">
                    <img src="/logo.png" onerror="this.src='https://placehold.co/100x100?text=SM'" alt="Logo" class="w-14 h-14 object-contain opacity-90">
                </div>
                <h1 class="text-2xl font-bold tracking-tight text-gray-900">Sauki Mart</h1>
                <p class="text-xs text-gray-500 mt-2 px-4 leading-relaxed font-medium">
                    Premium Data, Routers & SIMs.<br>
                    <span class="text-gray-400">Swift Delivery • Secure Payments</span>
                </p>
                <div class="flex items-center gap-2 mt-4">
                     <span class="px-3 py-1 bg-green-50 text-green-700 text-[10px] font-bold rounded-full border border-green-100 uppercase tracking-wider">SMEDAN Certified</span>
                </div>
            </div>

            <!-- The 4 Doors -->
            <div class="grid grid-cols-2 gap-4 flex-1 content-start">
                
                <!-- Door 1: Shop Devices -->
                <div onclick="navTo('view-shop')" class="door-card bg-white rounded-3xl p-5 flex flex-col items-center justify-center text-center h-44 border border-gray-100 shadow-sm cursor-pointer relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-br from-orange-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="w-14 h-14 bg-orange-50 rounded-full flex items-center justify-center mb-3 text-orange-500 relative z-10">
                        <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-sm text-gray-800 relative z-10">Shop Devices</h3>
                    <p class="text-[10px] text-gray-400 mt-1 relative z-10">Routers & SIMs</p>
                </div>

                <!-- Door 2: Buy Data -->
                <div onclick="navTo('view-data')" class="door-card bg-white rounded-3xl p-5 flex flex-col items-center justify-center text-center h-44 border border-gray-100 shadow-sm cursor-pointer relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="w-14 h-14 bg-blue-50 rounded-full flex items-center justify-center mb-3 text-blue-600 relative z-10">
                        <i data-lucide="wifi" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-sm text-gray-800 relative z-10">Buy Data</h3>
                    <p class="text-[10px] text-gray-400 mt-1 relative z-10">Instant Delivery</p>
                </div>

                <!-- Door 3: Agent -->
                <div onclick="navTo('view-agent')" class="door-card bg-white rounded-3xl p-5 flex flex-col items-center justify-center text-center h-44 border border-gray-100 shadow-sm cursor-pointer relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-br from-purple-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="w-14 h-14 bg-purple-50 rounded-full flex items-center justify-center mb-3 text-purple-600 relative z-10">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-sm text-gray-800 relative z-10">Become Agent</h3>
                    <p class="text-[10px] text-gray-400 mt-1 relative z-10">Partner with Us</p>
                </div>

                <!-- Door 4: Track -->
                <div onclick="navTo('view-track')" class="door-card bg-white rounded-3xl p-5 flex flex-col items-center justify-center text-center h-44 border border-gray-100 shadow-sm cursor-pointer relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-br from-green-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="w-14 h-14 bg-green-50 rounded-full flex items-center justify-center mb-3 text-green-600 relative z-10">
                        <i data-lucide="search" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-sm text-gray-800 relative z-10">Track Order</h3>
                    <p class="text-[10px] text-gray-400 mt-1 relative z-10">Check Status</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-auto pt-8 pb-4 flex flex-col items-center opacity-60">
                <div class="flex gap-4 mb-3 grayscale mix-blend-multiply">
                     <img src="/coat.png" onerror="this.style.display='none'" class="h-8 object-contain">
                     <img src="/smedan.png" onerror="this.style.display='none'" class="h-8 object-contain">
                </div>
                <p class="text-[10px] text-gray-400 font-medium">Support: saukidatalinks@gmail.com</p>
                <div onclick="navTo('view-admin')" class="mt-4 px-4 py-2 text-[9px] text-gray-300 uppercase tracking-widest cursor-pointer hover:text-gray-500 transition-colors">Admin Login</div>
            </div>
        </div>

        <!-- ======================= 2. DATA VIEW ======================= -->
        <div id="view-data" class="view no-scrollbar bg-white">
            <!-- Header -->
            <div class="glass sticky top-0 z-30 px-6 py-5 flex items-center justify-between">
                <button onclick="navBack()" class="p-2 -ml-2 rounded-full hover:bg-gray-50 transition-colors btn-press"><i data-lucide="chevron-left" class="w-6 h-6 text-gray-700"></i></button>
                <h2 class="font-bold text-base text-gray-800">Buy Mobile Data</h2>
                <div class="w-8"></div>
            </div>

            <div class="p-6 pb-24">
                <!-- Network Selector -->
                <label class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider pl-1">Select Network</label>
                <div class="flex gap-4 mb-8">
                    <button onclick="selectNetwork(1)" id="btn-net-mtn" class="flex-1 h-24 border-2 border-yellow-400 bg-yellow-50 rounded-2xl flex flex-col items-center justify-center transition-all shadow-sm ring-2 ring-offset-2 ring-transparent btn-press relative overflow-hidden">
                        <div class="w-full h-1 bg-yellow-400 absolute top-0"></div>
                        <span class="font-bold text-lg text-gray-900">MTN</span>
                        <span class="text-[10px] text-gray-600 mt-1">SME & Direct</span>
                    </button>
                    <button onclick="selectNetwork(2)" id="btn-net-glo" class="flex-1 h-24 border border-gray-100 bg-white rounded-2xl flex flex-col items-center justify-center grayscale opacity-60 transition-all shadow-sm btn-press relative overflow-hidden">
                        <div class="w-full h-1 bg-green-500 absolute top-0"></div>
                        <span class="font-bold text-lg text-green-700">Glo</span>
                        <span class="text-[10px] text-gray-400 mt-1">Corporate</span>
                    </button>
                </div>

                <!-- Input Phone -->
                <div class="mb-8">
                    <label class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider pl-1">Beneficiary Number</label>
                    <div class="relative group">
                        <input type="tel" id="data-phone" placeholder="0801 234 5678" class="w-full bg-gray-50 border border-gray-200 text-gray-900 text-xl font-semibold rounded-2xl p-5 pl-14 focus:bg-white focus:ring-2 focus:ring-black focus:border-transparent outline-none transition-all placeholder-gray-300">
                        <i data-lucide="smartphone" class="absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400 w-6 h-6 group-focus-within:text-black transition-colors"></i>
                    </div>
                </div>

                <!-- Plan Selector -->
                <label class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider pl-1">Choose Plan</label>
                <div id="plan-list" class="space-y-3">
                    <!-- Loading Skeleton -->
                    <div class="animate-pulse space-y-3">
                        <div class="h-20 bg-gray-100 rounded-2xl"></div>
                        <div class="h-20 bg-gray-100 rounded-2xl"></div>
                        <div class="h-20 bg-gray-100 rounded-2xl"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ======================= 3. SHOP DEVICES VIEW ======================= -->
        <div id="view-shop" class="view no-scrollbar bg-white">
            <div class="glass sticky top-0 z-30 px-6 py-5 flex items-center justify-between">
                <button onclick="navBack()" class="p-2 -ml-2 rounded-full hover:bg-gray-50 btn-press"><i data-lucide="chevron-left" class="w-6 h-6 text-gray-700"></i></button>
                <h2 class="font-bold text-base text-gray-800">Premium Devices</h2>
                <div class="w-8"></div>
            </div>

            <div class="p-6">
                <div id="product-list" class="grid grid-cols-1 gap-6">
                    <div class="text-center text-gray-400 mt-20 flex flex-col items-center">
                        <i data-lucide="package-open" class="w-12 h-12 mb-3 opacity-20"></i>
                        <p class="text-sm">Store is updating...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ======================= 4. TRACK VIEW ======================= -->
        <div id="view-track" class="view no-scrollbar bg-white">
            <div class="glass sticky top-0 z-30 px-6 py-5 flex items-center justify-between">
                <button onclick="navBack()" class="p-2 -ml-2 rounded-full hover:bg-gray-50 btn-press"><i data-lucide="chevron-left" class="w-6 h-6 text-gray-700"></i></button>
                <h2 class="font-bold text-base text-gray-800">Track Orders</h2>
                <div class="w-8"></div>
            </div>

            <div class="p-6">
                <div class="mb-8">
                    <label class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider pl-1">Phone Number</label>
                    <div class="flex gap-3">
                        <input type="tel" id="track-phone" placeholder="0801..." class="flex-1 bg-gray-50 border border-gray-200 rounded-2xl p-4 outline-none focus:ring-2 focus:ring-black focus:bg-white transition-all">
                        <button onclick="fetchHistory()" class="bg-black text-white px-6 rounded-2xl font-bold text-sm hover:bg-gray-800 btn-press transition-transform shadow-lg shadow-gray-200">
                            Check
                        </button>
                    </div>
                </div>

                <div id="history-list" class="space-y-4">
                    <div class="text-center text-gray-400 py-20 flex flex-col items-center">
                        <i data-lucide="history" class="w-12 h-12 mb-4 opacity-10"></i>
                        <span class="text-xs font-medium">Enter your number to view recent transactions</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ======================= 5. AGENT VIEW ======================= -->
        <div id="view-agent" class="view no-scrollbar bg-white">
            <div class="glass sticky top-0 z-30 px-6 py-5 flex items-center justify-between">
                <button onclick="navBack()" class="p-2 -ml-2 rounded-full hover:bg-gray-50 btn-press"><i data-lucide="chevron-left" class="w-6 h-6 text-gray-700"></i></button>
                <h2 class="font-bold text-base text-gray-800">Partner Program</h2>
                <div class="w-8"></div>
            </div>

            <div class="p-8 flex flex-col items-center justify-center min-h-[60vh] text-center">
                <div class="w-20 h-20 bg-purple-50 text-purple-600 rounded-3xl flex items-center justify-center mb-6 shadow-sm border border-purple-100">
                    <i data-lucide="crown" class="w-10 h-10"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Become a Partner</h3>
                <p class="text-sm text-gray-500 mb-10 max-w-[260px] leading-relaxed">Unlock exclusive wholesale rates on data and devices. Resell to your community and earn.</p>
                
                <button class="w-full bg-black text-white py-4 rounded-2xl font-bold shadow-xl shadow-gray-200 btn-press mb-4">Partner Login</button>
                <button class="w-full bg-white border border-gray-200 text-gray-800 py-4 rounded-2xl font-bold btn-press">Request Access</button>
            </div>
        </div>

        <!-- ======================= ADMIN VIEW ======================= -->
        <div id="view-admin" class="view no-scrollbar bg-gray-900 text-white">
            <div class="px-6 py-5 flex items-center justify-between border-b border-gray-800">
                <button onclick="navBack()" class="p-2 -ml-2 rounded-full hover:bg-gray-800 btn-press"><i data-lucide="chevron-left" class="w-6 h-6 text-gray-400"></i></button>
                <h2 class="font-semibold text-sm tracking-wide">ADMIN CONSOLE</h2>
                <div class="w-8"></div>
            </div>
            
            <div id="admin-login" class="p-6 pt-10">
                <h3 class="text-2xl font-bold mb-8">Restricted Access</h3>
                <div class="space-y-4">
                    <input id="admin-user" type="email" placeholder="Admin Email" class="w-full bg-gray-800 border-none rounded-2xl p-4 text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500">
                    <input id="admin-pass" type="password" placeholder="Passcode" class="w-full bg-gray-800 border-none rounded-2xl p-4 text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="adminLogin()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-bold mt-8 transition-colors shadow-lg shadow-blue-900/20 btn-press">Authenticate</button>
            </div>

            <div id="admin-dash" class="hidden p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-400 text-xs uppercase tracking-wider">Live Feed</h3>
                    <button onclick="loadAdminTxs()" class="p-2 bg-gray-800 rounded-xl hover:bg-gray-700 btn-press"><i data-lucide="refresh-cw" class="w-4 h-4 text-white"></i></button>
                </div>
                <div id="admin-tx-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- ======================= MODALS ======================= -->

        <!-- Payment Modal (Enhanced for Real Bank Account) -->
        <div id="payment-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-md hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white w-full max-w-sm rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 animate-slide-up shadow-2xl relative">
                <button onclick="closeModal('payment-modal')" class="absolute top-6 right-6 p-2 bg-gray-50 rounded-full text-gray-400 hover:text-gray-900 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-green-50 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 border border-green-100">
                        <i data-lucide="credit-card" class="w-8 h-8"></i>
                    </div>
                    <h3 class="font-bold text-xl text-gray-900">Payment Required</h3>
                    <p class="text-xs text-gray-500 mt-2 px-6">Transfer the <span class="font-bold text-gray-900">EXACT</span> amount to the dedicated account below to complete your order.</p>
                </div>

                <div class="bg-gray-50 p-6 rounded-3xl border border-gray-100 mb-8 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-400 to-emerald-600"></div>
                    
                    <!-- Bank Name -->
                    <p class="text-[10px] uppercase text-gray-400 font-bold tracking-widest mb-1">Bank Name</p>
                    <p class="font-bold text-lg text-gray-900 mb-4" id="pay-bank">Loading...</p>
                    
                    <!-- Account Number -->
                    <p class="text-[10px] uppercase text-gray-400 font-bold tracking-widest mb-1">Account Number</p>
                    <div class="flex items-center justify-center gap-3 mb-5 bg-white py-3 px-4 rounded-xl border border-gray-100 shadow-sm mx-4">
                        <p class="text-3xl font-mono font-bold tracking-wider text-gray-800" id="pay-acc">...</p>
                        <i onclick="copyToClipboard('pay-acc')" data-lucide="copy" class="w-5 h-5 text-gray-400 cursor-pointer hover:text-black transition-colors"></i>
                    </div>

                    <!-- Amount -->
                    <p class="text-[10px] uppercase text-gray-400 font-bold tracking-widest mb-1">Total Amount</p>
                    <p class="text-2xl font-bold text-green-600" id="pay-amt">₦0.00</p>
                    
                    <p class="text-[10px] text-gray-400 mt-3" id="pay-name">Beneficiary: Sauki Mart</p>
                </div>

                <button onclick="confirmPayment()" class="w-full bg-black text-white py-5 rounded-2xl font-bold text-lg shadow-xl shadow-gray-200 btn-press mb-4">
                    I Have Sent The Money
                </button>
                <button onclick="closeModal('payment-modal')" class="w-full text-gray-400 text-xs font-medium py-2 hover:text-gray-600">Cancel Transaction</button>
            </div>
        </div>

        <!-- Receipt Modal -->
        <div id="receipt-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-md hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl relative">
                
                <!-- Receipt Content to Capture -->
                <div id="receipt-content" class="bg-white p-6 border border-dashed border-gray-200 rounded-3xl mb-6 relative overflow-hidden">
                    <!-- Decor -->
                    <div class="absolute -left-3 -top-3 w-6 h-6 rounded-full bg-gray-100"></div>
                    <div class="absolute -right-3 -top-3 w-6 h-6 rounded-full bg-gray-100"></div>
                    
                    <div class="text-center border-b border-gray-100 pb-6 mb-6">
                        <div class="w-12 h-12 bg-black text-white rounded-xl flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="check" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-lg uppercase tracking-widest text-gray-900">Sauki Mart</h3>
                        <p class="text-[10px] text-gray-400 font-medium">Official Transaction Receipt</p>
                    </div>
                    
                    <div class="space-y-4 text-sm">
                        <div class="flex justify-between"><span class="text-gray-400 font-medium">Status</span> <span class="font-bold text-green-600 uppercase bg-green-50 px-2 py-0.5 rounded text-xs" id="rcpt-status">SUCCESS</span></div>
                        <div class="flex justify-between"><span class="text-gray-400 font-medium">Reference</span> <span class="font-mono text-xs text-right text-gray-600" id="rcpt-ref">...</span></div>
                        <div class="flex justify-between"><span class="text-gray-400 font-medium">Date</span> <span class="text-right text-gray-800 font-medium" id="rcpt-date">...</span></div>
                        <div class="flex justify-between"><span class="text-gray-400 font-medium">Product</span> <span class="text-right font-bold text-gray-800" id="rcpt-item">...</span></div>
                        <div class="flex justify-between border-t border-gray-100 pt-3"><span class="text-gray-400 font-medium">Total Paid</span> <span class="font-bold text-lg text-gray-900" id="rcpt-amt">...</span></div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-gray-100 text-center">
                        <p class="text-[10px] text-gray-400">Thank you for your patronage.</p>
                        <p class="text-[9px] text-gray-300 mt-1">saukidatalinks@gmail.com</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="downloadReceipt()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 btn-press shadow-lg shadow-blue-100">
                        <i data-lucide="download" class="w-4 h-4"></i> Save
                    </button>
                    <button onclick="closeModal('receipt-modal'); navTo('view-home')" class="flex-1 bg-gray-100 text-gray-800 py-4 rounded-2xl font-bold btn-press">
                        Done
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- APP LOGIC -->
    <script>
        // --- CONSTANTS ---
        const API_BASE = '/api'; 
        const NETWORK_MTN = 1;
        const NETWORK_GLO = 2;

        // --- STATE ---
        let currentView = 'view-home';
        let viewHistory = [];
        let selectedNetwork = NETWORK_MTN;
        let selectedPlan = null;
        let currentTxRef = null;
        let adminToken = null;
        let pollingInterval = null;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchPlans();
            // Clean up loaders if stuck
            showLoader(false);
        });

        // --- NAVIGATION ---
        function navTo(viewId) {
            if (viewId === currentView) return;
            const current = document.getElementById(currentView);
            const next = document.getElementById(viewId);

            viewHistory.push(currentView);
            
            // Animation reset
            next.style.transition = 'none';
            next.style.transform = 'translateX(100%)';
            next.offsetHeight; // Force reflow
            next.style.transition = '';

            current.classList.add('exit-left');
            current.classList.remove('active');

            next.classList.add('active');
            next.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                current.classList.remove('exit-left');
                current.style.transform = 'translateX(100%)';
            }, 400);

            currentView = viewId;
        }

        function navBack() {
            if (viewHistory.length === 0) return;
            const prevId = viewHistory.pop();
            const current = document.getElementById(currentView);
            const prev = document.getElementById(prevId);

            current.classList.remove('active');
            current.style.transform = 'translateX(100%)';
            
            // Bring previous back from left (-30%) to 0
            prev.classList.add('active');
            prev.style.transform = 'translateX(0)';

            currentView = prevId;
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            if(pollingInterval) clearInterval(pollingInterval);
        }

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-[-40px]');
            setTimeout(() => {
                t.classList.add('opacity-0', 'translate-y-[-40px]');
            }, 3000);
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => toast("Copied to clipboard"));
        }

        // --- DATA BUYING LOGIC ---
        function selectNetwork(netId) {
            selectedNetwork = netId;
            const mtnBtn = document.getElementById('btn-net-mtn');
            const gloBtn = document.getElementById('btn-net-glo');
            
            if(netId === 1) {
                // Active MTN
                mtnBtn.classList.replace('border-gray-200', 'border-yellow-400');
                mtnBtn.classList.replace('bg-white', 'bg-yellow-50');
                mtnBtn.classList.remove('grayscale', 'opacity-60');
                mtnBtn.classList.add('ring-2');
                
                // Inactive Glo
                gloBtn.classList.add('grayscale', 'opacity-60');
                gloBtn.classList.remove('ring-2');
                gloBtn.classList.replace('border-green-500', 'border-gray-100');
            } else {
                // Active Glo
                gloBtn.classList.replace('border-gray-100', 'border-green-500');
                gloBtn.classList.remove('grayscale', 'opacity-60');
                gloBtn.classList.add('ring-2');

                // Inactive MTN
                mtnBtn.classList.add('grayscale', 'opacity-60');
                mtnBtn.classList.remove('ring-2');
                mtnBtn.classList.replace('border-yellow-400', 'border-gray-200');
            }
            renderPlans();
        }

        let allPlans = [];
        async function fetchPlans() {
            try {
                const res = await fetch(`${API_BASE}/plans`);
                allPlans = await res.json();
                renderPlans();
            } catch(e) { console.error("Plan Error", e); }
        }

        function renderPlans() {
            const container = document.getElementById('plan-list');
            container.innerHTML = '';
            
            // Filter by network
            const filtered = allPlans.filter(p => p.networkId === selectedNetwork);
            
            if(filtered.length === 0) {
                // Fallback Mock Data for demo if DB is empty
                const mocks = selectedNetwork === 1 
                    ? [{id:1001, name:'1GB SME', price:429, desc:'30 Days'}, {id:6666, name:'2GB SME', price:849, desc:'30 Days'}, {id:1110, name:'5GB SME', price:2100, desc:'30 Days'}]
                    : [{id:206, name:'1GB Corp', price:399, desc:'30 Days'}, {id:222, name:'2GB Corp', price:799, desc:'30 Days'}];
                
                mocks.forEach(p => appendPlanCard(p, container));
            } else {
                filtered.forEach(p => appendPlanCard(p, container));
            }
        }

        function appendPlanCard(p, container) {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between p-5 bg-white border border-gray-100 rounded-2xl cursor-pointer hover:border-black hover:shadow-md transition-all btn-press group";
            div.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full ${selectedNetwork === 1 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'} flex items-center justify-center font-bold text-xs">
                        ${p.name.split(' ')[0]}
                    </div>
                    <div>
                        <p class="font-bold text-gray-900">${p.name}</p>
                        <p class="text-[10px] text-gray-500 font-medium">30 Days Validity</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-base text-gray-900 group-hover:text-blue-600 transition-colors">₦${p.price}</p>
                </div>
            `;
            div.onclick = () => initiateDataPurchase(p);
            container.appendChild(div);
        }

        async function initiateDataPurchase(plan) {
            const phone = document.getElementById('data-phone').value;
            if(phone.length < 10) return toast("Enter valid phone number");

            selectedPlan = plan;
            showLoader(true);

            try {
                // Call API to init purchase and get REAL Bank Account
                const res = await fetch(`${API_BASE}/buy/init`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        amount: plan.price,
                        phone: phone,
                        type: 'data',
                        networkId: selectedNetwork,
                        planId: plan.id || plan.planId,
                        productName: `${selectedNetwork === 1 ? 'MTN' : 'Glo'} ${plan.name}`
                    })
                });
                const data = await res.json();
                
                if(data.success) {
                    currentTxRef = data.reference;
                    
                    // POPULATE MODAL WITH REAL FLUTTERWAVE ACCOUNT DATA
                    document.getElementById('pay-bank').innerText = data.bankName || "Unknown Bank";
                    document.getElementById('pay-acc').innerText = data.accountNumber || "ERROR";
                    document.getElementById('pay-amt').innerText = `₦${data.payableAmount || plan.price}`;
                    document.getElementById('pay-name').innerText = `Ref: ${data.reference.substring(0,8)}...`; 

                    openModal('payment-modal');
                } else {
                    toast("Failed: " + (data.error || "System Error"));
                }
            } catch(e) {
                toast("Connection Error. Check internet.");
                console.error(e);
            } finally {
                showLoader(false);
            }
        }

        // --- PAYMENT VERIFICATION ---
        async function confirmPayment() {
            if(!currentTxRef) return;
            
            showLoader(true);
            
            try {
                const res = await fetch(`${API_BASE}/buy/verify`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ reference: currentTxRef })
                });
                const data = await res.json();
                
                // Logic based on API response scenarios
                if(data.payment && data.delivery) {
                    // Success!
                    closeModal('payment-modal');
                    showReceipt(data.tx);
                } else if(data.payment && !data.delivery) {
                    // Paid, but Amigo is slow or failed
                    toast(data.message || "Payment received! Delivering data...");
                    // Optional: Poll again in 3s
                } else {
                    // Not paid yet
                    toast("Payment not yet confirmed. Please ensure you sent the exact amount.");
                }
            } catch(e) {
                toast("Verification Error");
            } finally {
                showLoader(false);
            }
        }

        // --- RECEIPT & TRACKING ---
        function showReceipt(tx) {
            openModal('receipt-modal');
            document.getElementById('rcpt-status').innerText = "SUCCESS";
            document.getElementById('rcpt-ref').innerText = tx.reference;
            document.getElementById('rcpt-date').innerText = new Date().toLocaleDateString();
            document.getElementById('rcpt-item').innerText = tx.planName || "Data Bundle";
            document.getElementById('rcpt-amt').innerText = `₦${tx.amount}`;
        }

        async function downloadReceipt() {
            const element = document.getElementById('receipt-content');
            
            // Use html2canvas options for better quality
            const canvas = await html2canvas(element, { scale: 3, backgroundColor: null });
            const imgData = canvas.toDataURL('image/png');
            
            const link = document.createElement('a');
            link.href = imgData;
            link.download = `SaukiReceipt-${Date.now()}.png`;
            link.click();
            toast("Receipt Saved to Gallery");
        }

        async function fetchHistory() {
            const phone = document.getElementById('track-phone').value;
            if(phone.length < 10) return toast("Enter valid phone");
            
            showLoader(true);
            const list = document.getElementById('history-list');
            list.innerHTML = '';

            try {
                const res = await fetch(`${API_BASE}/track/${phone}`);
                const txs = await res.json();
                
                if(txs.length === 0) {
                    list.innerHTML = '<div class="text-center text-xs text-gray-500 py-4">No recent transactions found.</div>';
                }

                txs.forEach(tx => {
                    const isSuccess = tx.status === 'delivered';
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100";
                    div.innerHTML = `
                        <div class="flex gap-3 items-center">
                            <div class="w-10 h-10 rounded-full ${isSuccess ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'} flex items-center justify-center">
                                <i data-lucide="${isSuccess ? 'check' : 'clock'}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-bold text-sm text-gray-800">${tx.planName || 'Transaction'}</p>
                                <p class="text-[10px] text-gray-500">${new Date(tx.createdAt).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-bold ${isSuccess ? 'text-green-600' : 'text-yellow-600'} uppercase">${tx.status}</span>
                        </div>
                    `;
                    // Click to download receipt if delivered
                    if(isSuccess) {
                        div.classList.add('cursor-pointer', 'active:scale-95', 'transition-transform');
                        div.onclick = () => showReceipt(tx);
                    }
                    list.appendChild(div);
                });
            } catch(e) { toast("Error fetching history"); }
            finally { showLoader(false); lucide.createIcons(); }
        }

        // --- ADMIN LOGIN (Simple) ---
        async function adminLogin() {
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            
            showLoader(true);
            try {
                const res = await fetch(`${API_BASE}/admin/login`, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({u,p})
                });
                const d = await res.json();
                if(d.success) {
                    adminToken = d.token;
                    document.getElementById('admin-login').classList.add('hidden');
                    document.getElementById('admin-dash').classList.remove('hidden');
                    loadAdminTxs();
                } else {
                    toast("Invalid Access Credentials");
                }
            } catch(e) { toast("Login Error"); }
            finally { showLoader(false); }
        }

        async function loadAdminTxs() {
            if(!adminToken) return;
            const res = await fetch(`${API_BASE}/admin/transactions`, {
                headers: { 'Authorization': adminToken }
            });
            const txs = await res.json();
            const list = document.getElementById('admin-tx-list');
            list.innerHTML = txs.map(t => `
                <div class="flex justify-between items-center bg-gray-800 p-3 rounded-xl border border-gray-700 text-xs">
                    <div>
                        <div class="font-bold text-white">${t.customerPhone}</div>
                        <div class="text-gray-500">${t.reference}</div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="${t.status === 'delivered' ? 'text-green-400' : (t.status === 'paid' ? 'text-blue-400' : 'text-red-400')} font-bold uppercase">${t.status}</span>
                        ${t.status === 'paid' ? `<button onclick="retryTx('${t.id}')" class="px-2 py-1 bg-blue-600 rounded text-white text-[9px]">RETRY</button>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        async function retryTx(id) {
            if(!confirm("Retry delivery for this transaction?")) return;
            try {
                const res = await fetch(`${API_BASE}/admin/retry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': adminToken },
                    body: JSON.stringify({id})
                });
                const d = await res.json();
                if(d.success) { toast("Retry Sent!"); loadAdminTxs(); }
                else toast("Retry Failed: " + d.error);
            } catch(e) { toast("Network Error"); }
        }

    </script>
</body>
</html>
