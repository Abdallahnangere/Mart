<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sauki Mart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f2f2f7; color: #000; height: 100dvh; overflow: hidden; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-sheet { background: #fff; width: 100%; max-width: 500px; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 24px; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .btn-press:active { transform: scale(0.97); opacity: 0.9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .status-pill { font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: 700; text-transform: uppercase; }
        .status-success { background: #e6f9f0; color: #0c6b48; }
        .status-failed { background: #fff0f0; color: #c00; }
        .footer-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="flex flex-col h-[100dvh]">

    <!-- AGENT HEADER (Hidden by default) -->
    <div id="agentHeader" class="bg-black text-white p-6 pb-8 hidden">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-xs text-gray-400 uppercase font-bold">Wallet Balance</p>
                <h1 class="text-3xl font-bold mt-1" id="agentBal">₦0.00</h1>
            </div>
            <button onclick="logoutAgent()" class="bg-gray-800 p-2 rounded-full"><i data-lucide="log-out" class="w-4 h-4"></i></button>
        </div>
        <div class="mt-4 flex gap-3">
            <button onclick="openFundModal()" class="flex-1 bg-white text-black py-2 rounded-xl text-sm font-bold btn-press">Fund Wallet</button>
            <button onclick="refreshAgent()" class="p-2 bg-gray-800 rounded-xl"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
        </div>
    </div>

    <!-- GUEST HEADER -->
    <header id="guestHeader" class="text-center pt-8 pb-4 flex flex-col items-center flex-shrink-0">
        <img src="logo.png" onerror="this.src='https://placehold.co/100'" class="w-20 h-20 rounded-2xl shadow-sm mb-3 object-cover">
        <h1 class="text-2xl font-bold tracking-tight">SAUKI MART</h1>
        <p class="text-xs text-gray-500 max-w-[260px] leading-tight mt-1">
            Premium Data & Devices. <br> <span class="text-green-600 font-bold">SMEDAN Certified</span>
        </p>
    </header>

    <!-- MAIN GRID -->
    <main class="flex-1 overflow-y-auto p-4 flex flex-col justify-center max-w-md mx-auto w-full">
        <div class="card-grid">
            <div onclick="openShop()" class="bg-white p-5 h-36 rounded-3xl shadow-sm border border-gray-100 flex flex-col justify-center items-center gap-2 btn-press cursor-pointer">
                <i data-lucide="smartphone" class="w-8 h-8 text-blue-600"></i>
                <span class="font-bold text-sm text-gray-800">Shop</span>
            </div>
            <div onclick="openBuyData()" class="bg-gray-900 p-5 h-36 rounded-3xl shadow-lg flex flex-col justify-center items-center gap-2 btn-press cursor-pointer">
                <i data-lucide="wifi" class="w-8 h-8 text-white"></i>
                <span class="font-bold text-sm text-white">Buy Data</span>
            </div>
            <div id="agentCard" onclick="openAgent()" class="bg-white p-5 h-36 rounded-3xl shadow-sm border border-gray-100 flex flex-col justify-center items-center gap-2 btn-press cursor-pointer">
                <i data-lucide="users" class="w-8 h-8 text-purple-600"></i>
                <span class="font-bold text-sm text-gray-800">Agent</span>
            </div>
            <div onclick="openTrack()" class="bg-white p-5 h-36 rounded-3xl shadow-sm border border-gray-100 flex flex-col justify-center items-center gap-2 btn-press cursor-pointer">
                <i data-lucide="search" class="w-8 h-8 text-orange-600"></i>
                <span class="font-bold text-sm text-gray-800">Track TX</span>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="text-center p-4 footer-safe bg-white/50 backdrop-blur-md border-t border-gray-200 flex-shrink-0">
        <div class="flex justify-center items-center gap-4 opacity-50 mb-3">
            <img src="coat.png" class="h-6 onerror-hide">
            <div class="h-4 w-px bg-gray-400"></div>
            <img src="smedan.png" class="h-6 onerror-hide">
        </div>
        <div class="text-[10px] text-gray-400 font-medium">
            <a href="tel:08164135836">08164135836</a> • <a href="tel:08061934056">08061934056</a>
        </div>
    </footer>

    <!-- === MODALS === -->

    <!-- 1. DATA MODAL -->
    <div id="dataModal" class="modal-overlay" onclick="if(event.target === this) closeAll()">
        <div class="modal-sheet">
            <h2 class="text-xl font-bold mb-4">Buy Data Bundle</h2>
            
            <label class="text-xs font-bold text-gray-400 uppercase">Network</label>
            <div class="grid grid-cols-2 gap-3 mb-4 mt-2">
                <button onclick="setNet('MTN', 1, this)" class="net-btn p-3 border rounded-xl font-bold text-sm hover:bg-yellow-50 hover:border-yellow-400">MTN</button>
                <button onclick="setNet('GLO', 2, this)" class="net-btn p-3 border rounded-xl font-bold text-sm hover:bg-green-50 hover:border-green-400">GLO</button>
            </div>

            <div class="space-y-3">
                <input type="tel" id="dataPhone" placeholder="Phone Number" class="w-full p-4 bg-gray-50 rounded-xl font-medium outline-none border focus:border-black">
                <select id="dataPlan" class="w-full p-4 bg-gray-50 rounded-xl font-medium outline-none border focus:border-black">
                    <option value="">Select Plan</option>
                </select>
                
                <!-- Agent PIN Input (Hidden for Guest) -->
                <div id="agentPinArea" class="hidden">
                    <input type="password" id="walletPin" placeholder="Enter Agent PIN" class="w-full p-4 bg-gray-50 rounded-xl font-medium outline-none border border-purple-200 focus:border-purple-500">
                </div>
            </div>

            <button onclick="processDataPurchase()" class="w-full bg-black text-white p-4 rounded-xl font-bold text-lg mt-6 btn-press shadow-lg">Proceed</button>
        </div>
    </div>

    <!-- 2. PAYMENT MODAL (Guest) -->
    <div id="payModal" class="modal-overlay">
        <div class="modal-sheet text-center">
            <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="banknote" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold">Transfer Exact Amount</h3>
            <p class="text-sm text-gray-500 mb-6">Account generated for this transaction.</p>

            <div class="bg-gray-50 p-6 rounded-2xl mb-6">
                <p class="text-xs text-gray-400 uppercase">Bank</p>
                <p id="payBank" class="font-bold text-lg">Loading...</p>
                <div class="h-px bg-gray-200 my-2"></div>
                <p class="text-xs text-gray-400 uppercase">Account Number</p>
                <p id="payAcc" class="font-mono text-3xl font-bold tracking-wider my-1">---</p>
                <div class="h-px bg-gray-200 my-2"></div>
                <p class="text-xl font-bold text-green-600" id="payAmt">₦0.00</p>
            </div>

            <button onclick="checkPaymentStatus()" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold mb-3">I Have Paid</button>
            <button onclick="closeAll()" class="text-gray-400 text-sm">Cancel</button>
            <p id="payStatus" class="text-xs font-bold text-orange-500 mt-2 h-4"></p>
        </div>
    </div>

    <!-- 3. SHOP MODAL -->
    <div id="shopModal" class="modal-overlay" onclick="if(event.target === this) closeAll()">
        <div class="modal-sheet">
            <h2 class="text-xl font-bold mb-4">Shop Devices</h2>
            <div id="shopList" class="space-y-4">
                <!-- Products -->
            </div>
        </div>
    </div>

    <!-- 4. AGENT LOGIN/REG -->
    <div id="agentModal" class="modal-overlay" onclick="if(event.target === this) closeAll()">
        <div class="modal-sheet">
            <div class="flex gap-2 mb-6 bg-gray-100 p-1 rounded-xl">
                <button onclick="toggleAgentForm('login')" class="flex-1 py-2 rounded-lg bg-white shadow-sm text-sm font-bold">Login</button>
                <button onclick="toggleAgentForm('reg')" class="flex-1 py-2 rounded-lg text-gray-500 text-sm font-bold">Register</button>
            </div>

            <div id="loginForm" class="space-y-3">
                <input type="tel" id="agPhone" placeholder="Phone" class="w-full p-3 bg-gray-50 rounded-xl border">
                <input type="password" id="agPin" placeholder="PIN" class="w-full p-3 bg-gray-50 rounded-xl border">
                <button onclick="agentLogin()" class="w-full bg-purple-600 text-white p-3 rounded-xl font-bold mt-2">Login</button>
            </div>

            <div id="regForm" class="space-y-3 hidden">
                <input type="text" id="regName" placeholder="Full Name" class="w-full p-3 bg-gray-50 rounded-xl border">
                <input type="tel" id="regPhone" placeholder="Phone" class="w-full p-3 bg-gray-50 rounded-xl border">
                <input type="email" id="regEmail" placeholder="Email" class="w-full p-3 bg-gray-50 rounded-xl border">
                <input type="password" id="regPin" placeholder="Create PIN" class="w-full p-3 bg-gray-50 rounded-xl border">
                <button onclick="agentReg()" class="w-full bg-black text-white p-3 rounded-xl font-bold mt-2">Register</button>
            </div>
        </div>
    </div>

    <!-- 5. FUND WALLET MODAL -->
    <div id="fundModal" class="modal-overlay" onclick="if(event.target === this) closeAll()">
        <div class="modal-sheet">
            <h3 class="text-lg font-bold mb-2">Fund Wallet</h3>
            <p class="text-sm text-gray-500 mb-6">Transfer to your dedicated account.</p>
            
            <div id="staticAccountArea" class="bg-gray-50 p-6 rounded-2xl text-center">
                <p>Generating Account...</p>
            </div>
        </div>
    </div>

    <!-- 6. RECEIPT MODAL -->
    <div id="receiptModal" class="modal-overlay">
        <div class="modal-sheet">
            <div id="receiptCanvas" class="bg-white border p-6 text-center">
                <h2 class="font-bold text-2xl tracking-tighter">SAUKI MART</h2>
                <p class="text-xs text-gray-500 mb-4">Transaction Receipt</p>
                <div class="text-left text-sm space-y-2 font-mono">
                    <p class="flex justify-between"><span>Ref:</span> <span id="recRef"></span></p>
                    <p class="flex justify-between"><span>Date:</span> <span id="recDate"></span></p>
                    <p class="flex justify-between"><span>Item:</span> <span id="recItem"></span></p>
                    <div class="border-t my-2"></div>
                    <p class="flex justify-between font-bold text-lg"><span>Total:</span> <span id="recAmt"></span></p>
                </div>
                <div class="mt-4 text-[10px] text-gray-400">SMEDAN Certified</div>
            </div>
            <button onclick="dlReceipt()" class="w-full bg-black text-white p-3 rounded-xl font-bold mt-4">Save Receipt</button>
            <button onclick="closeAll()" class="w-full text-gray-400 p-2 text-sm mt-2">Close</button>
        </div>
    </div>

    <!-- 7. TRACK MODAL -->
    <div id="trackModal" class="modal-overlay" onclick="if(event.target === this) closeAll()">
        <div class="modal-sheet">
            <h2 class="text-lg font-bold mb-4">Track Transaction</h2>
            <div class="flex gap-2 mb-4">
                <input id="trackInput" type="tel" placeholder="Phone Number" class="flex-1 p-3 bg-gray-50 rounded-xl border">
                <button onclick="doTrack()" class="bg-black text-white px-4 rounded-xl font-bold">Check</button>
            </div>
            <div id="trackResults" class="space-y-2"></div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // GLOBAL STATE
        let activeAgent = JSON.parse(localStorage.getItem('sauki_agent'));
        let selectedNet = null;
        let selectedNetId = null;
        let currentTxRef = null;

        // INIT
        if (activeAgent) loadAgentMode();

        // UTILS
        function closeAll() { document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active')); }
        function openShop() { document.getElementById('shopModal').classList.add('active'); fetchProducts(); }
        function openBuyData() { document.getElementById('dataModal').classList.add('active'); fetchPlans(); }
        function openAgent() { if(activeAgent) return; document.getElementById('agentModal').classList.add('active'); }
        function openTrack() { document.getElementById('trackModal').classList.add('active'); }
        
        // AGENT LOGIC
        function loadAgentMode() {
            document.getElementById('agentHeader').classList.remove('hidden');
            document.getElementById('guestHeader').classList.add('hidden');
            document.getElementById('agentCard').classList.add('hidden');
            document.getElementById('agentBal').innerText = `₦${activeAgent.balance.toLocaleString()}`;
            document.getElementById('agentPinArea').classList.remove('hidden');
        }

        async function agentLogin() {
            const phone = document.getElementById('agPhone').value;
            const pin = document.getElementById('agPin').value;
            try {
                const res = await fetch('/api/agent/login', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ phone, pin })
                });
                const data = await res.json();
                if(data.success) {
                    activeAgent = data.agent;
                    localStorage.setItem('sauki_agent', JSON.stringify(activeAgent));
                    closeAll();
                    loadAgentMode();
                } else { alert(data.error); }
            } catch(e) { alert('Error logging in'); }
        }

        async function agentReg() {
             const body = {
                name: document.getElementById('regName').value,
                phone: document.getElementById('regPhone').value,
                email: document.getElementById('regEmail').value,
                pin: document.getElementById('regPin').value
             };
             const res = await fetch('/api/agent/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
             const data = await res.json();
             if(data.success) { alert('Registration sent. Contact Admin for approval.'); closeAll(); }
             else { alert(data.error); }
        }

        async function openFundModal() {
            document.getElementById('fundModal').classList.add('active');
            const res = await fetch('/api/agent/create-account', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ agentId: activeAgent.id })
            });
            const data = await res.json();
            if(data.success) {
                const ag = data.agent;
                activeAgent = ag;
                localStorage.setItem('sauki_agent', JSON.stringify(ag));
                document.getElementById('staticAccountArea').innerHTML = `
                    <p class="text-xs text-gray-400 uppercase">Bank</p>
                    <p class="font-bold text-lg">${ag.virtualAccountBank}</p>
                    <p class="text-3xl font-mono font-bold my-2">${ag.virtualAccountNumber}</p>
                    <p class="text-sm font-medium text-purple-600">${ag.virtualAccountName}</p>
                `;
            }
        }

        // DATA BUYING
        async function fetchPlans() {
            const res = await fetch('/api/plans');
            const plans = await res.json();
            window.allPlans = plans;
        }

        function setNet(name, id, btn) {
            selectedNet = name;
            selectedNetId = id;
            document.querySelectorAll('.net-btn').forEach(b => b.classList.remove('bg-gray-100', 'border-black'));
            btn.classList.add('border-black', 'bg-gray-50');
            
            const select = document.getElementById('dataPlan');
            select.innerHTML = '<option value="">Select Plan</option>';
            window.allPlans.filter(p => p.network === name).forEach(p => {
                select.innerHTML += `<option value="${p.planId}" data-price="${p.price}" data-name="${p.name}">${p.name} - ₦${p.price}</option>`;
            });
        }

        async function processDataPurchase() {
            const phone = document.getElementById('dataPhone').value;
            const select = document.getElementById('dataPlan');
            const planId = select.value;
            const planName = select.options[select.selectedIndex].dataset.name;
            const price = select.options[select.selectedIndex].dataset.price;
            
            if(!planId || !phone) return alert("Fill all fields");

            if(activeAgent) {
                // WALLET FLOW
                const pin = document.getElementById('walletPin').value;
                if(!pin) return alert("Enter Agent PIN");
                
                if(confirm(`Deduct ₦${price} from wallet?`)) {
                    const res = await fetch('/api/agent/buy', {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ agentId: activeAgent.id, pin, amount: price, networkId: selectedNetId, planId, phone })
                    });
                    const data = await res.json();
                    if(data.success) {
                        alert('Data Delivered!');
                        activeAgent.balance -= price;
                        localStorage.setItem('sauki_agent', JSON.stringify(activeAgent));
                        document.getElementById('agentBal').innerText = `₦${activeAgent.balance.toLocaleString()}`;
                        closeAll();
                        // Show Receipt
                        showReceipt({reference: data.txRef, amount: price, description: planName});
                    } else {
                        alert(data.error);
                    }
                }
            } else {
                // GUEST FLOW (TRANSFER)
                document.getElementById('dataModal').classList.remove('active');
                document.getElementById('payModal').classList.add('active');
                
                const res = await fetch('/api/pay/charge', {
                    method: 'POST', headers: {'Content-Type':'application/json'},body: JSON.stringify({
                        amount: price, phone, name: 'Guest', type: 'DATA_PURCHASE',
                        metadata: { networkId: selectedNetId, planId: planId, planName, desc: `${selectedNet} ${planName}` }
                    })
                });
                const data = await res.json();
                if(data.status === 'success') {
                    document.getElementById('payBank').innerText = data.bank_name;
                    document.getElementById('payAcc').innerText = data.account_number;
                    document.getElementById('payAmt').innerText = `₦${data.amount}`;
                    currentTxRef = data.ref;
                } else {
                    alert('Payment Init Failed: ' + data.error);
                    closeAll();
                }
            }
        }

        async function checkPaymentStatus() {
            const stat = document.getElementById('payStatus');
            stat.innerText = 'Verifying...';
            try {
                const res = await fetch(`/api/transaction/check/${currentTxRef}`);
                const data = await res.json();
                if(data.status === 'SUCCESS') {
                    closeAll();
                    showReceipt(data.tx);
                } else {
                    stat.innerText = 'Payment not found yet.';
                }
            } catch(e) { stat.innerText = 'Error checking.'; }
        }

        // SHOP LOGIC
        async function fetchProducts() {
            const list = document.getElementById('shopList');
            const res = await fetch('/api/products');
            const products = await res.json();
            list.innerHTML = products.map(p => `
                <div class="bg-gray-50 p-4 rounded-xl flex items-center gap-4 cursor-pointer hover:bg-gray-100" onclick="alert('To buy devices, please contact support on WhatsApp.')">
                    <img src="${p.image}" class="w-16 h-16 object-contain">
                    <div>
                        <h4 class="font-bold">${p.name}</h4>
                        <p class="text-sm text-gray-500">₦${p.price.toLocaleString()}</p>
                    </div>
                </div>
            `).join('');
        }

        // TRACK LOGIC
        async function doTrack() {
            const ph = document.getElementById('trackInput').value;
            const res = await fetch(`/api/track/${ph}`);
            const txs = await res.json();
            document.getElementById('trackResults').innerHTML = txs.map(tx => `
                <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center text-sm">
                    <div>
                        <p class="font-bold">${tx.description || tx.type}</p>
                        <p class="text-xs text-gray-400">${new Date(tx.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div class="text-right">
                        <span class="status-pill ${tx.status==='SUCCESS'?'status-success':'status-failed'}">${tx.status}</span>
                    </div>
                </div>
            `).join('');
        }

        // RECEIPT
        function showReceipt(tx) {
            document.getElementById('receiptModal').classList.add('active');
            document.getElementById('recRef').innerText = tx.reference;
            document.getElementById('recDate').innerText = new Date().toLocaleDateString();
            document.getElementById('recItem').innerText = tx.description;
            document.getElementById('recAmt').innerText = `₦${tx.amount.toLocaleString()}`;
        }
        
        function dlReceipt() {
            html2canvas(document.querySelector("#receiptCanvas")).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL("image/png");
                a.download = 'Receipt.png';
                a.click();
            });
        }
        
        function logoutAgent() {
            localStorage.removeItem('sauki_agent');
            location.reload();
        }
    </script>
</body>
</html>
