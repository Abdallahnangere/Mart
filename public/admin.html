<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sauki Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body{background:#f5f5f7; font-family:-apple-system,sans-serif;}
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .inp { width: 100%; background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #eee; }
        .btn { width: 100%; background: black; color: white; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn:hover { opacity: 0.9; }
        .tab-btn { padding: 10px 20px; font-weight: 600; color: #888; border-radius: 20px; transition: all 0.2s; }
        .tab-btn.active { background: white; color: black; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .edit-mode { border: 2px solid #007aff; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-6xl mx-auto">

    <!-- LOGIN -->
    <div id="loginOverlay" class="fixed inset-0 bg-gray-100 z-50 flex items-center justify-center">
        <div class="card w-96 text-center">
            <h1 class="text-2xl font-bold mb-6">Admin Access</h1>
            <input type="email" id="admEmail" placeholder="Email" class="inp">
            <input type="password" id="admPass" placeholder="Password" class="inp">
            <button onclick="login()" class="btn">Login</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Sauki Admin</h1>
            <div class="bg-gray-200 p-1 rounded-full flex overflow-x-auto">
                <button onclick="tab('tx', this)" class="tab-btn active">Tx</button>
                <button onclick="tab('ag', this)" class="tab-btn">Agents</button>
                <button onclick="tab('prod', this)" class="tab-btn">Products</button>
                <button onclick="tab('plan', this)" class="tab-btn">Plans</button>
            </div>
        </header>

        <!-- TRANSACTIONS -->
        <div id="tx" class="section">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="card"><p class="text-gray-500 text-xs uppercase">Revenue</p><h2 id="rev" class="text-2xl font-bold">...</h2></div>
                <div class="card"><p class="text-gray-500 text-xs uppercase">Pending Agents</p><h2 id="pendAg" class="text-2xl font-bold">...</h2></div>
            </div>
            <div class="card overflow-hidden overflow-x-auto">
                <table class="w-full text-left text-sm min-w-[600px]">
                    <thead><tr class="text-gray-400 border-b">
                        <th class="p-3">Ref</th>
                        <th class="p-3">Type</th>
                        <th class="p-3">Amount</th>
                        <th class="p-3">Status</th>
                        <th class="p-3">Action</th>
                    </tr></thead>
                    <tbody id="txBody"></tbody>
                </table>
            </div>
        </div>

        <!-- AGENTS -->
        <div id="ag" class="section hidden">
            <div class="card overflow-x-auto">
                <h2 class="font-bold mb-4">Manage Agents</h2>
                <table class="w-full text-left text-sm min-w-[600px]">
                    <thead><tr class="text-gray-400 border-b"><th class="p-3">Name</th><th class="p-3">Phone</th><th class="p-3">Status</th><th class="p-3">Action</th></tr></thead>
                    <tbody id="agBody"></tbody>
                </table>
            </div>
        </div>

        <!-- PRODUCTS -->
        <div id="prod" class="section hidden">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Add/Edit Form -->
                <div class="card w-full md:w-1/3 h-fit" id="prodFormCard">
                    <h2 class="font-bold mb-4" id="prodFormTitle">Add Device</h2>
                    <input id="pName" placeholder="Name" class="inp">
                    <input id="pPrice" type="number" placeholder="Price" class="inp">
                    <input id="pDesc" placeholder="Description" class="inp">
                    
                    <label class="text-xs font-bold text-gray-500 mb-2 block">Image (Leave empty to keep current)</label>
                    <input type="file" id="pImageFile" class="inp border-dashed" accept="image/*">
                    <input type="hidden" id="pImageBase64">
                    
                    <button onclick="saveProd()" id="prodBtn" class="btn mt-2">Save Product</button>
                    <button onclick="resetProdForm()" id="prodCancelBtn" class="btn bg-gray-200 text-gray-600 mt-2 hidden">Cancel Edit</button>
                </div>
                <!-- List -->
                <div class="card flex-1">
                    <h2 class="font-bold mb-4">Inventory</h2>
                    <div id="prodList" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- PLANS -->
        <div id="plan" class="section hidden">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Add/Edit Plan Form -->
                <div class="card w-full md:w-1/3 h-fit" id="planFormCard">
                    <h2 class="font-bold mb-4" id="planFormTitle">Add Data Plan</h2>
                    <select id="plNet" class="inp">
                        <option value="MTN">MTN</option>
                        <option value="GLO">GLO</option>
                    </select>
                    <input id="plNetId" type="number" placeholder="Net ID (1=MTN, 2=GLO)" class="inp">
                    <input id="plAmigoId" type="number" placeholder="Amigo Plan ID (e.g 1001)" class="inp">
                    <input id="plName" placeholder="Display Name (e.g 1GB 30Days)" class="inp">
                    <input id="plPrice" type="number" placeholder="Selling Price" class="inp">
                    
                    <button onclick="savePlan()" id="planBtn" class="btn mt-2">Save Plan</button>
                    <button onclick="resetPlanForm()" id="planCancelBtn" class="btn bg-gray-200 text-gray-600 mt-2 hidden">Cancel Edit</button>
                </div>
                <!-- List -->
                <div class="card flex-1">
                    <h2 class="font-bold mb-4">Active Plans</h2>
                    <div id="planList" class="space-y-2"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const API = '/api';
        
        // STATE
        let allProducts = [];
        let allPlans = [];
        let editingProdId = null;
        let editingPlanId = null;

        // ICONS
        lucide.createIcons();

        // LOGIN
        async function login() {
            const email = document.getElementById('admEmail').value;
            const password = document.getElementById('admPass').value;
            try {
                const res = await fetch(`${API}/admin/login`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ email, password })
                });
                const d = await res.json();
                if(d.success) {
                    document.getElementById('loginOverlay').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadAll();
                } else alert('Invalid');
            } catch(e) { alert('Error'); }
        }

        function tab(id, btn) {
            document.querySelectorAll('.section').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        async function loadAll() {
            // Stats & TX
            const sRes = await fetch(`${API}/admin/stats`);
            const stats = await sRes.json();
            document.getElementById('rev').innerText = `₦${stats.revenue.toLocaleString()}`;
            document.getElementById('pendAg').innerText = stats.pendingAgents;
            document.getElementById('txBody').innerHTML = stats.recentTx.map(tx => `
                <tr class="border-b">
                    <td class="p-3 font-mono text-xs">${tx.reference}</td>
                    <td class="p-3 text-xs font-bold">${tx.type}</td>
                    <td class="p-3">₦${tx.amount}</td>
                    <td class="p-3 text-xs font-bold ${tx.status==='SUCCESS'?'text-green-600':'text-orange-500'}">${tx.status}</td>
                    <td class="p-3">
                        ${tx.status === 'SUCCESS' && tx.type === 'DATA_PURCHASE' ? 
                        `<button onclick="retry('${tx.id}')" class="bg-black text-white px-2 py-1 rounded text-xs">Retry</button>` : ''}
                    </td>
                </tr>
            `).join('');

            // Agents
            const aRes = await fetch(`${API}/admin/agents`);
            const ags = await aRes.json();
            document.getElementById('agBody').innerHTML = ags.map(a => `
                <tr class="border-b">
                    <td class="p-3 font-bold">${a.name}</td>
                    <td class="p-3">${a.phone}</td>
                    <td class="p-3 text-xs">${a.status}</td>
                    <td class="p-3">
                        ${a.status === 'PENDING' ? 
                        `<button onclick="appr('${a.id}')" class="text-green-600 font-bold text-xs">Approve</button>` : 
                        '<span class="text-gray-300">-</span>'}
                    </td>
                </tr>
            `).join('');

            // Products
            const pRes = await fetch(`${API}/products`);
            allProducts = await pRes.json();
            document.getElementById('prodList').innerHTML = allProducts.map(p => `
                <div class="flex items-center gap-4 bg-gray-50 p-2 rounded">
                    <img src="${p.image}" class="w-10 h-10 object-contain bg-white">
                    <div class="flex-1">
                        <p class="font-bold text-sm">${p.name}</p>
                        <p class="text-xs text-gray-500">₦${p.price}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editProd('${p.id}')" class="text-blue-600 text-xs font-bold"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="delProd('${p.id}')" class="text-red-500 text-xs font-bold"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();

            // Plans
            const plRes = await fetch(`${API}/plans`);
            allPlans = await plRes.json();
            document.getElementById('planList').innerHTML = allPlans.map(p => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                    <div>
                        <span class="font-bold text-xs bg-black text-white px-1 rounded mr-2">${p.network}</span>
                        <span class="text-sm font-medium">${p.name}</span>
                        <span class="text-xs text-gray-500 block">ID: ${p.planId} | Price: ₦${p.price}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editPlan('${p.id}')" class="text-blue-600 text-xs font-bold"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="delPlan('${p.id}')" class="text-red-500 text-xs font-bold"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // IMAGE HANDLER
        document.getElementById('pImageFile').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('pImageBase64').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // --- PRODUCT ACTIONS ---
        async function saveProd() {
            const body = {
                name: document.getElementById('pName').value,
                price: document.getElementById('pPrice').value,
                description: document.getElementById('pDesc').value,
                image: document.getElementById('pImageBase64').value
            };
            
            let url = `${API}/admin/product/add`;
            if (editingProdId) {
                url = `${API}/admin/product/update`;
                body.id = editingProdId;
            } else if(!body.image) {
                 return alert('Image required for new products');
            }

            await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
            resetProdForm();
            loadAll();
            alert(editingProdId ? 'Product Updated' : 'Product Added');
        }

        function editProd(id) {
            const p = allProducts.find(x => x.id === id);
            if (!p) return;
            editingProdId = id;
            document.getElementById('pName').value = p.name;
            document.getElementById('pPrice').value = p.price;
            document.getElementById('pDesc').value = p.description;
            document.getElementById('pImageBase64').value = ""; // Don't preload base64, server handles keep-old
            
            // UI Update
            document.getElementById('prodFormTitle').innerText = "Edit Product";
            document.getElementById('prodBtn').innerText = "Update Product";
            document.getElementById('prodCancelBtn').classList.remove('hidden');
            document.getElementById('prodFormCard').classList.add('edit-mode');
        }

        function resetProdForm() {
            editingProdId = null;
            document.getElementById('pName').value = "";
            document.getElementById('pPrice').value = "";
            document.getElementById('pDesc').value = "";
            document.getElementById('pImageFile').value = "";
            document.getElementById('pImageBase64').value = "";
            
            document.getElementById('prodFormTitle').innerText = "Add Device";
            document.getElementById('prodBtn').innerText = "Save Product";
            document.getElementById('prodCancelBtn').classList.add('hidden');
            document.getElementById('prodFormCard').classList.remove('edit-mode');
        }

        async function delProd(id) {
            if(confirm('Delete?')) {
                await fetch(`${API}/admin/product/delete`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})});
                loadAll();
            }
        }

        // --- PLAN ACTIONS ---
        async function savePlan() {
            const body = {
                network: document.getElementById('plNet').value,
                networkId: document.getElementById('plNetId').value,
                planId: document.getElementById('plAmigoId').value,
                name: document.getElementById('plName').value,
                price: document.getElementById('plPrice').value
            };
            
            let url = `${API}/admin/plans/add`;
            if (editingPlanId) {
                url = `${API}/admin/plans/update`;
                body.id = editingPlanId;
            }

            await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
            resetPlanForm();
            loadAll();
            alert(editingPlanId ? 'Plan Updated' : 'Plan Added');
        }

        function editPlan(id) {
            const p = allPlans.find(x => x.id === id);
            if(!p) return;
            editingPlanId = id;
            document.getElementById('plNet').value = p.network;
            document.getElementById('plNetId').value = p.networkId;
            document.getElementById('plAmigoId').value = p.planId;
            document.getElementById('plName').value = p.name;
            document.getElementById('plPrice').value = p.price;
            
            document.getElementById('planFormTitle').innerText = "Edit Data Plan";
            document.getElementById('planBtn').innerText = "Update Plan";
            document.getElementById('planCancelBtn').classList.remove('hidden');
            document.getElementById('planFormCard').classList.add('edit-mode');
        }

        function resetPlanForm() {
            editingPlanId = null;
            document.getElementById('plNet').value = "MTN";
            document.getElementById('plNetId').value = "";
            document.getElementById('plAmigoId').value = "";
            document.getElementById('plName').value = "";
            document.getElementById('plPrice').value = "";
            
            document.getElementById('planFormTitle').innerText = "Add Data Plan";
            document.getElementById('planBtn').innerText = "Save Plan";
            document.getElementById('planCancelBtn').classList.add('hidden');
            document.getElementById('planFormCard').classList.remove('edit-mode');
        }

        async function delPlan(id) {
            if(confirm('Delete Plan?')) {
                await fetch(`${API}/admin/plans/delete`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})});
                loadAll();
            }
        }

        async function retry(id) {
            const res = await fetch(`${API}/admin/retry`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({txId: id})});
            const d = await res.json();
            alert(d.success ? 'Retried' : 'Failed');
        }

        async function appr(id) {
            await fetch(`${API}/admin/agent/approve`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({agentId: id, action: 'ACTIVE'})});
            loadAll();
        }
    </script>
</body>
</html>


